
CREATE OR REPLACE FUNCTION gtest.resize_all() 
	RETURNS void AS $$
	
	BEGIN
	
	delete from gtest.resized;

	insert into gtest.resized(sec,reversed,xsp,s_ch,e_ch,pks,geom)
	select pieces.sec,pieces.reversed,pieces.xsp,s_ch,e_ch,array_agg(pk) as pks,geom
	from gtest.pieces as pieces left join gtest.fitted as fitted on fitted.sec=pieces.sec and fitted.xsp=pieces.xsp and fitted.reversed=pieces.reversed and s_ch<=sec_ch and sec_ch<=e_ch
	group by pieces.sec,pieces.reversed,pieces.xsp,s_ch,e_ch,geom;

	update gtest.resized set pks=array( select pk from gtest.fitted as f where f.sec=resized.sec and f.xsp=resized.xsp and f.reversed=resized.reversed and s_ch-10<=sec_ch and sec_ch<=e_ch+10) where cardinality(pks)=0;

	perform gtest.calc_benchmarks();
	update resized set sfc= (select avg(fitted.sfc) from gtest.fitted where fitted.pk=any(pks));
																		  
	END;			
$$ LANGUAGE plpgsql;


